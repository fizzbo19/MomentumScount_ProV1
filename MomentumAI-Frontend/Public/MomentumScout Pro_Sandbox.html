<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MomentumScout — Pro Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { font-family: 'Inter', sans-serif; background:#0d1117; color:#c9d1d9; }
  .attribute-slider { -webkit-appearance:none; appearance:none; width:100%; height:8px; background:#21262d; outline:none; border-radius:6px; transition:opacity .12s; }
  .attribute-slider:hover { opacity:1; }
  .attribute-slider::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; background:#22c55e; border-radius:50%; cursor:pointer; }
  .modal { display:none; position:fixed; inset:0; z-index:50; background:rgba(2,6,23,0.8); overflow:auto; }
  .spinner { border:4px solid rgba(255,255,255,0.15); border-top:4px solid #22c55e; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .top-five { box-shadow:0 8px 30px rgba(250,204,21,0.08); border:2px solid #facc15; transform:scale(1.02); }
  .fade-in { animation: fadeIn .24s ease-in-out both; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:none; } }
  .chip { background:#111827; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.04); font-size:0.875rem; }
  .small { font-size:0.85rem; }
  table.projection-table { width:100%; border-collapse:collapse; margin-top:8px; }
  table.projection-table th, table.projection-table td { border:1px solid #2b3138; padding:6px; text-align:center; font-size:0.9rem; }
  table.projection-table th { color:#facc15; background:#0f1724; }
  /* New style for input boxes */
  .value-input { background:#111827; border:1px solid #374151; padding:8px; border-radius:6px; width:100%; color:#c9d1d9; }
</style>
</head>
<body class="min-h-screen p-6">

<script>
  const pwd = prompt("Enter access code:");
  if (pwd !== "SCOUT2025") { alert("Access denied."); window.location.href = "index.html"; }
</script>

<div id="playerModal" class="modal">
  <div class="max-w-3xl mx-auto mt-12 bg-gray-800 rounded-xl p-6 relative">
    <button id="closeModal" class="absolute top-4 right-4 text-gray-300 hover:text-white text-2xl">&times;</button>
    <div id="modalInner"></div>
  </div>
</div>

<div class="max-w-6xl mx-auto space-y-8">

  <header class="text-center">
    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500">MomentumScout Pro</h1>
    <p class="text-gray-400 mt-2">Advanced Player Scouting • Projections • Negotiation Guidance</p>
  </header>

  <section class="bg-gray-800 border border-gray-700 rounded-xl p-6">
    <div class="flex gap-3 items-center">
      <input id="playerNameSearch" class="flex-1 rounded-md p-3 bg-gray-700 text-white border border-gray-600" placeholder="Search player (e.g. Lionel Messi)">
      <button id="searchPlayerBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-md text-gray-900 font-semibold">Search</button>
      <div id="searchStatus" class="ml-4 chip hidden small"></div>
    </div>

    <div id="playerSearchResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4"></div>
  </section>

  <section class="bg-gray-800 border border-gray-700 rounded-xl p-6">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-semibold text-green-400">Scouting Profile</h2>
      <div class="flex gap-2">
        <button id="resetBtn" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-md">Reset All Sliders</button>
        <button id="findPlayersBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-md text-gray-900 font-semibold">Find Top Players</button>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <label class="block text-sm mb-2">Position</label>
        <select id="position" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white"></select>

        <div class="mt-4 space-y-3" id="coreSliders">
          </div>
      </div>

      <div>
        <h4 class="text-sm text-gray-300 mb-2">Position Metrics</h4>
        <div id="dynamicMetrics" class="space-y-4 max-h-72 overflow-auto pr-2"></div>
      </div>

      <div>
        <h4 class="text-sm text-gray-300 mb-2">Attribute Weighting (Desire)</h4>
        <div id="weightingSliders" class="space-y-3 max-h-72 overflow-auto pr-2"></div>
      </div>
    </div>
  </section>

  <section class="bg-gray-800 border border-gray-700 rounded-xl p-6">
    <h3 class="text-2xl font-semibold text-green-400 text-center">Top Player Recommendations</h3>
    <div class="mt-4 flex justify-center">
      <div id="loadingIndicator" class="hidden"><div class="spinner"></div></div>
    </div>
    <div id="recommendations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6"></div>
    <div id="noResults" class="text-center text-gray-400 mt-4 hidden">No players found — try different sliders or check backend connection.</div>
  </section>

</div>

<script>
/* ------------- Configuration ------------- */
const BACKEND_BASE = "https://momentumai-backend-g1ov.onrender.com/api"; // Render URL placeholder
const DEFAULT_VALUE_MIN = 100000;
const DEFAULT_VALUE_MAX = 50000000;

/* ------------- Elements ------------- */
const posSelect = document.getElementById('position');
const coreSliders = document.getElementById('coreSliders');
const dynMetrics = document.getElementById('dynamicMetrics');
const weightContainer = document.getElementById('weightingSliders');
const findBtn = document.getElementById('findPlayersBtn');
const resetBtn = document.getElementById('resetBtn');
const recommendations = document.getElementById('recommendations');
const loadingIndicator = document.getElementById('loadingIndicator');
const searchBtn = document.getElementById('searchPlayerBtn');
const playerNameSearch = document.getElementById('playerNameSearch');
const playerSearchResults = document.getElementById('playerSearchResults');
const searchStatus = document.getElementById('searchStatus');
const noResults = document.getElementById('noResults');
const modal = document.getElementById('playerModal');
const modalInner = document.getElementById('modalInner');
const closeModal = document.getElementById('closeModal');

closeModal.addEventListener('click', ()=> modal.style.display='none');
window.addEventListener('click', (e)=> { if (e.target === modal) modal.style.display='none'; });

/* ------------- Position metrics (same as backend mapping) ------------- */
const POSITIONS = ['GK','CB','LB','RB','CDM','CM','CAM','RW','LW','CF','ST'];
const POSITION_METRICS = {
  // Goalkeeper (GK)
  'GK': { 
    display:['goalkeeping_diving','goalkeeping_handling','goalkeeping_kicking','goalkeeping_positioning','goalkeeping_reflexes'], 
    weights:['goalkeeping_diving','goalkeeping_handling','goalkeeping_kicking','goalkeeping_positioning','goalkeeping_reflexes'] 
  },
  // Centre Back (CB)
  'CB': { 
    display:['defending_marking_awareness','defending_standing_tackle','defending_sliding_tackle','power_strength','power_jumping','mentality_interceptions','pace','passing'], 
    weights:['defending_standing_tackle', 'defending_marking_awareness', 'power_strength', 'mentality_interceptions', 'pace', 'passing'] 
  },
  // Left Back (LB)
  'LB': { 
    display:['defending_marking_awareness','defending_standing_tackle','defending_sliding_tackle','pace','passing','attacking_crossing'], 
    weights:['pace','passing','defending_standing_tackle', 'attacking_crossing'] 
  },
  // Right Back (RB)
  'RB': { 
    display:['defending_marking_awareness','defending_standing_tackle','defending_sliding_tackle','pace','passing','attacking_crossing'], 
    weights:['pace','passing','defending_standing_tackle', 'attacking_crossing'] 
  },
  // Defensive Midfielder (CDM)
  'CDM':{ 
    display:['defending_standing_tackle','mentality_interceptions','passing','physic','power_stamina','power_strength','mentality_vision'], 
    weights:['pace','passing','defending_standing_tackle','physic', 'mentality_interceptions'] 
  },
  // Central Midfielder (CM)
  'CM': { 
    display:['passing','dribbling','shooting','defending','power_stamina','mentality_vision','skill_long_passing','skill_ball_control'], 
    weights:['pace','passing','dribbling','defending','physic'] 
  },
  // Attacking Midfielder (CAM)
  'CAM':{ 
    display:['passing','dribbling','shooting','mentality_vision','skill_curve','skill_fk_accuracy','movement_agility'], 
    weights:['pace','shooting','passing','dribbling', 'mentality_vision'] 
  },
  // Right Winger (RW)
  'RW': { 
    display:['pace','dribbling','shooting','passing','movement_acceleration','movement_sprint_speed','attacking_crossing','skill_ball_control'], 
    weights:['pace','shooting','passing','dribbling', 'attacking_crossing'] 
  },
  // Left Winger (LW)
  'LW': { 
    display:['pace','dribbling','shooting','passing','movement_acceleration','movement_sprint_speed','attacking_crossing','skill_ball_control'], 
    weights:['pace','shooting','passing','dribbling', 'attacking_crossing'] 
  },
  // Centre Forward (CF)
  'CF': { 
    display:['shooting','dribbling','passing','mentality_positioning','attacking_finishing','power_shot_power'], 
    weights:['pace','shooting','passing','dribbling', 'mentality_positioning'] 
  },
  // Striker (ST)
  'ST': { 
    display:['shooting','pace','dribbling','attacking_finishing','power_shot_power','power_strength','movement_acceleration', 'mentality_positioning'],
    weights:['pace','shooting','dribbling', 'mentality_positioning', 'attacking_finishing']
  }
};

/* ------------- Helpers: DOM building ------------- */
function niceName(key){
  return key.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
}

function sliderBlock(id, min=0, max=99, vMin=50, vMax=90){
  return `
    <div class="fade-in">
      <label class="block text-sm mb-1">${niceName(id)}: <span id="${id}Val" class="text-gray-300">${vMin} - ${vMax}</span></label>
      <input id="${id}_min" class="attribute-slider mb-2" type="range" min="${min}" max="${max}" value="${vMin}">
      <input id="${id}_max" class="attribute-slider" type="range" min="${min}" max="${max}" value="${vMax}">
    </div>`;
}

function weightBlock(attr, initial=50){
  return `
    <div class="fade-in">
      <label class="block text-sm mb-1">${niceName(attr)} Desire: <span id="w_${attr}_val" class="text-gray-300">${initial}</span></label>
      <input id="w_${attr}" class="attribute-slider" type="range" min="0" max="100" value="${initial}">
    </div>`;
}

/* ------------- Initialize UI ------------- */
function populatePositions(){
  POSITIONS.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p; opt.textContent = p;
    posSelect.appendChild(opt);
  });
}

// --- Build Core Sliders (Adjusted) ---
function buildCoreSliders() {
  coreSliders.innerHTML = ''; 

  // Overall slider
  coreSliders.insertAdjacentHTML('beforeend', createSlider('Overall', 50, 99, 75, 95));

  // Age slider
  coreSliders.insertAdjacentHTML('beforeend', createSlider('Age', 16, 45, 20, 30));

  // Value ($) INPUT BOXES
  coreSliders.insertAdjacentHTML('beforeend', createValueInputBlock('Value', DEFAULT_VALUE_MIN, DEFAULT_VALUE_MAX));

  // Setup listeners for dynamic update
  setupSliderListeners();
  setupValueInputListeners();
}

// --- Create Slider HTML ---
function createSlider(attr, min = 0, max = 100, valMin = min, valMax = max) {
  return `
    <div class="mb-4">
      <label class="block text-sm mb-1 font-medium">${attr}: 
        <span id="${attr}Val">${valMin} - ${valMax}</span>
      </label>
      <input id="${attr}_min" type="range" min="${min}" max="${max}" value="${valMin}" class="attribute-slider mb-2">
      <input id="${attr}_max" type="range" min="${min}" max="${max}" value="${valMax}" class="attribute-slider">
    </div>
  `;
}

// --- Create Value Input Block HTML ---
function createValueInputBlock(attr, valMin, valMax) {
  const fmt = v => '£' + Number(v).toLocaleString('en-GB', { maximumFractionDigits: 0 });
  return `
    <div class="mb-4 fade-in">
        <label class="block text-sm mb-1 font-medium">${attr} (GBP):</label>
        <div class="grid grid-cols-2 gap-2">
            <input id="${attr}_min" type="number" value="${valMin}" placeholder="Min (e.g. 100000)" class="value-input">
            <input id="${attr}_max" type="number" value="${valMax}" placeholder="Max (e.g. 50000000)" class="value-input">
        </div>
        <div class="text-xs text-gray-500 mt-1">Min: <span id="${attr}MinDisplay">${fmt(valMin)}</span> | Max: <span id="${attr}MaxDisplay">${fmt(valMax)}</span></div>
    </div>
  `;
}

// --- Setup Value Input Listeners ---
function setupValueInputListeners() {
  const minInput = document.getElementById('Value_min');
  const maxInput = document.getElementById('Value_max');
  const minDisplay = document.getElementById('ValueMinDisplay');
  const maxDisplay = document.getElementById('ValueMaxDisplay');

  const formatDisplay = (v) => v ? '£' + Number(v).toLocaleString('en-GB', { maximumFractionDigits: 0 }) : '—';

  const updateDisplay = () => {
    minDisplay.textContent = formatDisplay(minInput.value);
    maxDisplay.textContent = formatDisplay(maxInput.value);
  };

  if (minInput) minInput.oninput = updateDisplay;
  if (maxInput) maxInput.oninput = updateDisplay;
  
  // Initial display call
  if (minInput) updateDisplay();
}

// --- Setup Slider Listeners for Dynamic Update (for non-Value sliders) ---
function setupSliderListeners() {
  document.querySelectorAll('input[type="range"]').forEach(sl => {
    sl.oninput = () => {
      const spanId = sl.id.includes('w_') ? `${sl.id}_val` : `${sl.id.replace('_min','').replace('_max','')}Val`;
      const span = document.getElementById(spanId);
      if (!span) return;

      if (sl.id.includes('w_')) {
        span.textContent = sl.value;
      } else {
        const id = sl.id.replace('_min', '').replace('_max', '');
        const min = parseInt(document.getElementById(`${id}_min`).value);
        const max = parseInt(document.getElementById(`${id}_max`).value);
        // Note: This only handles non-Value sliders (Overall, Age) now
        span.textContent = `${min} - ${max}`;
      }
    };
  });
}

function buildPositionMetrics(pos){
  dynMetrics.innerHTML = '';
  const metrics = (POSITION_METRICS[pos] && POSITION_METRICS[pos].display) || [];
  metrics.forEach(m => dynMetrics.insertAdjacentHTML('beforeend', sliderBlock(m,0,99,50,75)));
}
function buildWeightSliders(pos){
  weightContainer.innerHTML = '<div class="text-sm text-gray-300 mb-2">Adjust how much each attribute matters for this search (0 = ignore, 100 = max).</div>';
  const weights = (POSITION_METRICS[pos] && POSITION_METRICS[pos].weights) || [];
  weights.forEach(w => weightContainer.insertAdjacentHTML('beforeend', weightBlock(w,50)));
}

/* update visible spans when sliders move */
function attachSliderListeners(){
  // This function is still necessary to attach listeners to the dynamic sliders
  document.querySelectorAll('input[type="range"]').forEach(sl=>{
    sl.oninput = () => {
      if (sl.id.startsWith('w_')) {
        const span = document.getElementById(sl.id + '_val');
        if (span) span.textContent = sl.value;
      } else {
        const base = sl.id.replace('_min','').replace('_max','');
        const minEl = document.getElementById(base + '_min');
        const maxEl = document.getElementById(base + '_max');
        const span = document.getElementById(base + 'Val');
        if (minEl && maxEl && span) span.textContent = `${minEl.value} - ${maxEl.value}`;
      }
    };
  });
}

/* reset all sliders to defaults */
function resetAll(){
  // rebuild full UI to known defaults
  buildCoreSliders(); // This rebuilds core sliders AND the value input boxes to defaults
  buildPositionMetrics(posSelect.value);
  buildWeightSliders(posSelect.value);
  attachSliderListeners(); // Reattach listeners for dynamic sliders
}

/* ------------- Projection & Negotiation logic (frontend) ------------- */
function projectionYearsFromAge(age){
  age = Number(age);
  if (age < 15) return 5;
  if (age <= 20) return 5;
  if (age <= 25) return 4;
  if (age <= 30) return 3;
  return 1;
}

/* simple projection model:
   - projected overall: small yearly change (you can replace this with ML later)
   - projected value: growth or decline factor depending on age */
function projectPlayer(initialOverall, initialValueEur, age){
  const years = projectionYearsFromAge(age);
  // value in EUR -> for UI we'll show in GBP millions when rendering (approx)
  // simple heuristic: younger players grow faster; older may decline
  const growthRates = (age <= 20) ? 1.12 : (age <= 25) ? 1.08 : (age <= 30) ? 1.05 : (age <= 35) ? 1.03 : 1.01;
  const overallChangePerYear = (age <= 20) ? 1.8 : (age <= 25) ? 1.2 : (age <= 30) ? 0.5 : -0.5;
  // build yearly projections
  const proj = [];
  let curOverall = Number(initialOverall) || 0;
  let curValue = Number(initialValueEur) || 0;
  for (let y=1; y<=years; y++){
    curOverall = Math.round(Math.max(40, Math.min(99, curOverall + overallChangePerYear)));
    curValue = Math.round(curValue * growthRates);
    proj.push({ year: y, overall: curOverall, value: curValue });
  }
  return proj;
}

/* negotiation guidance: min 80% of projected, max 120% */
function negotiationRange(projectedValue){
  const min = Math.round(projectedValue * 0.8);
  const max = Math.round(projectedValue * 1.2);
  return { min, max };
}

/* helper to format currency in GBP millions (approx) */
function fmtGBPFromEur(eur){
  if (!eur) return '£0.0M';
  // assume 1 EUR ~ 0.85 GBP (approx). Keep simple.
  const gbp = eur * 0.85;
  if (gbp >= 1_000_000) return `£${(gbp/1_000_000).toFixed(2)}M`;
  return `£${(gbp/1000).toFixed(0)}k`;
}

/* ------------- Fetch helpers ------------- */
async function safePost(endpoint, body){
  try {
    const resp = await fetch(BACKEND_BASE + endpoint, {
      method:'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body), 
      mode: 'cors'
    });
    
    // Check for HTTP errors (like 500, 404) BEFORE trying to read JSON
    if (!resp.ok) {
      const text = await resp.text().catch(()=>'');
      throw new Error(`Backend Status ${resp.status}: ${text}`);
    }
    
    // If status is OK (200), parse and return the JSON data
    return await resp.json();

  } catch(err) {
    console.error('safePost error', err);
    // Re-throw the error for the calling function to display
    throw err;
  }
}

/* --- Search player by name --- */
searchBtn.onclick = async ()=>{
  const q = playerNameSearch.value.trim();
  if (!q) return;
  playerSearchResults.innerHTML = '';
  searchStatus.classList.remove('hidden');
  searchStatus.textContent = 'Searching...';
  try {
    const payload = { player_name: q }; 
    const data = await safePost('/search_player', payload);
    
    if (!data || !data.length) {
      searchStatus.textContent = 'No results found.';
      return;
    }
    searchStatus.textContent = `${data.length} player(s) found`;
    data.forEach(pl=>{
      const card = renderPlayerCard(pl, 999);
      playerSearchResults.appendChild(card);
    });
  } catch(e){
    console.error(e);
    searchStatus.textContent = `⚠️ Failed to fetch from backend: ${e.message.substring(0, 50)}`;
  }
};


/* --- Find top players --- */
findBtn.onclick = async ()=>{
  recommendations.innerHTML = '';
  noResults.classList.add('hidden');
  loadingIndicator.classList.remove('hidden');

  try {
    const pos = posSelect.value;
    const body = { position: pos, filters:{}, weights:{} };

    // CORE & METRICS: Collect all slider values AND the number inputs
    document.querySelectorAll('#coreSliders input[type="range"], #dynamicMetrics input[type="range"], #coreSliders input[type="number"], #dynamicMetrics input[type="number"]').forEach(sl=>{
      const base = sl.id.replace('_min','').replace('_max','');
      const minEl = document.getElementById(base + '_min');
      const maxEl = document.getElementById(base + '_max');
      
      // Ensure we only process min inputs once
      if (sl.id.endsWith('_min') && minEl && maxEl) {
          // Send values as raw number (for GBP/EUR)
          body.filters[base] = [Number(minEl.value), Number(maxEl.value)];
      }
    });

    // weights
    document.querySelectorAll('#weightingSliders input[type="range"]').forEach(sl=>{
      if (sl.id.startsWith('w_')){
        const attr = sl.id.replace('w_','');
        body.weights[attr] = Number(sl.value);
      }
    });

    const data = await safePost('/find_players', body);
    loadingIndicator.classList.add('hidden');

    if (!data || !data.players || !data.players.length){
      noResults.classList.remove('hidden');
      return;
    }

    data.players.slice(0,5).forEach((p,i)=>{
      const card = renderPlayerCard(p,i);
      recommendations.appendChild(card);
    });

  } catch(e){
    console.error(e);
    loadingIndicator.classList.add('hidden');
    noResults.classList.remove('hidden');
    noResults.textContent = `⚠️ Could not load players — backend error: ${e.message.substring(0, 50)}`;
  }
};


/* ------------- Render players ------------- */
function renderPlayerCard(player, rankIndex){
  // player fields expected from backend: short_name, club_position, overall, potential, value_eur, player_face_url, min_value_eur, max_value_eur, full_attributes, etc.
  const card = document.createElement('div');
  card.className = 'bg-gray-800 p-4 rounded-xl border border-gray-700 hover:scale-105 transition-transform cursor-pointer';
  if (rankIndex < 5) card.classList.add('top-five');
  card.innerHTML = `
    <div class="flex items-center gap-3">
      <img src="${player.player_face_url || 'https://via.placeholder.com/96'}" alt="${player.short_name}" class="w-20 h-20 rounded-full border-2 border-green-500 object-cover">
      <div class="flex-1">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg font-semibold text-green-300">${player.short_name}</div>
            <div class="text-sm text-gray-300">${player.club_position} • OVR ${player.overall} • POT ${player.potential || 'N/A'}</div>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-300">Value</div>
            <div class="text-lg font-bold">${fmtGBPFromEur(player.value_eur || 0)}</div>
          </div>
        </div>
        <div class="mt-2 text-sm text-gray-400">Negotiation: <span class="font-semibold text-green-200">${fmtGBPFromEur(player.min_value_eur || 0)} - ${fmtGBPFromEur(player.max_value_eur || 0)}</span></div>
        <div class="mt-2 text-xs text-gray-500">Click for full attributes & projections</div>
      </div>
    </div>
  `;
  card.addEventListener('click', ()=> showPlayerModal(player));
  return card;
}

function showPlayerModal(player){
  // compute projections using backend values (value_eur) and OVR + age
  const age = player.full_attributes && player.full_attributes.Age ? Number(player.full_attributes.Age) : (player.age || 0);
  const initialOverall = player.full_attributes && player.full_attributes.Overall ? player.full_attributes.Overall : player.overall || 0;
  const initialValue = player.value_eur || 0;

  const projections = projectPlayer(initialOverall, initialValue, age);
  const latestProjection = projections.length ? projections[projections.length -1] : { overall: initialOverall, value: initialValue };
  const negotiation = negotiationRange(latestProjection.value);

  // build attributes list
  const attrs = player.full_attributes || {};
  let attributesHtml = `<div class="grid grid-cols-2 gap-2">`;
  for (const k of Object.keys(attrs)){
    attributesHtml += `<div class="text-sm text-gray-300"><strong>${k}:</strong> ${attrs[k] ?? '—'}</div>`;
  }
  attributesHtml += `</div>`;

  // projection table
  let projTable = `<table class="projection-table"><thead><tr><th>Year</th><th>Projected OVR</th><th>Projected Value (GBP)</th></tr></thead><tbody>`;
  projections.forEach(p => {
    projTable += `<tr><td>+${p.year}</td><td>${p.overall}</td><td>${fmtGBPFromEur(p.value)}</td></tr>`;
  });
  projTable += `</tbody></table>`;

  // negotiation guidance
  const negotiationHtml = `<div class="mt-3 text-sm text-gray-300">Negotiation guidance (based on projection): <div class="mt-1 font-semibold text-green-200">${fmtGBPFromEur(negotiation.min)} — ${fmtGBPFromEur(negotiation.max)}</div></div>`;

  modalInner.innerHTML = `
    <div class="space-y-4">
      <div class="flex items-center gap-4">
        <img src="${player.player_face_url || 'https://via.placeholder.com/120'}" class="w-24 h-24 rounded-full border-2 border-green-500">
        <div>
          <h3 class="2xl font-bold text-green-300">${player.short_name}</h3>
          <div class="text-sm text-gray-300">${player.club_position} • Age: ${age} • OVR: ${player.overall}</div>
          <div class="text-sm text-gray-400 mt-1">Value: ${fmtGBPFromEur(player.value_eur || 0)}</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
        <h4 class="text-sm text-gray-300 mb-2">Projections</h4>
          <div class="p-3 bg-gray-900 rounded">
            ${projTable}
            ${negotiationHtml}
          </div>
        </div>
        <div>
          <h4 class="text-sm text-gray-300 mb-2">Player Attributes</h4>
          <div class="p-3 bg-gray-900 rounded max-h-96 overflow-auto">
            ${attributesHtml}
          </div>
        </div>
      </div>
    </div>
  `;
  modal.style.display = 'block';
}

/* ------------- Boot ------------- */
function fullBoot(){
    populatePositions();
    posSelect.addEventListener('change', ()=>{
        buildPositionMetrics(posSelect.value);
        buildWeightSliders(posSelect.value);
        attachSliderListeners();
    });
    // Initial build for ST position
    buildCoreSliders();
    buildPositionMetrics(posSelect.value);
    buildWeightSliders(posSelect.value);
    attachSliderListeners();
}

fullBoot();
</script>
</body>
</html>